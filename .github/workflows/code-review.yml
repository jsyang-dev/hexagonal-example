name: ì½”ë“œ ë¦¬ë·°

on:
  issue_comment:
    types: [created]

jobs:
  code-review:
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '#ì½”ë“œë¦¬ë·°')
    runs-on: ubuntu-latest

    steps:
      - name: ë§ˆì§€ë§‰ ì»¤ë°‹ì˜ SHA ê°€ì ¸ì˜¤ê¸°
        id: get-sha
        run: |
          SHA=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }} \
            | jq -r '.head.sha')
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Check Run ìƒì„± (pending)
        id: create-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          response=$(curl -s -X POST https://api.github.com/repos/${{ github.repository }}/check-runs \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "name": "ì½”ë“œ ë¦¬ë·°",
              "head_sha": "${{ steps.get-sha.outputs.sha }}",
              "status": "in_progress",
              "output": {
                "title": "ì½”ë“œ ë¦¬ë·° ì§„í–‰ ì¤‘",
                "summary": "ì½”ë“œ ë¦¬ë·°ë¥¼ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤."
              }
            }')
          echo "$response"
          check_id=$(echo "$response" | jq -r '.id')
          echo "check_id=$check_id" >> $GITHUB_OUTPUT

      - name: n8n ì›Œí¬í”Œë¡œìš° í˜¸ì¶œ
        id: call-n8n
        run: |
          response=$(curl -s -X POST https://8013-116-33-11-45.ngrok-free.app/webhook/ec464db8-8d7b-47d6-bef3-b19a2aa7f045 \
            -H "Content-Type: application/json" \
            -d '{
              "owner": "${{ github.repository_owner }}",
              "repo": "${{ github.event.repository.name }}",
              "pullNumber": "${{ github.event.issue.number }}"
            }')

          echo "$response" > result.json

      - name: ì½”ë“œ ë¦¬ë·° ê²°ê³¼ ì¶œë ¥
        run: cat result.json

      - name: ë¼ì¸ë³„ ì½”ë©˜íŠ¸ ì‘ì„±
        run: |
          if [ ! -s result.json ]; then
            echo "result.json is empty! Skipping comments."
            exit 0
          fi

          count=$(jq '.reviews | length' result.json)
          if [ "$count" -eq 0 ]; then
            echo "ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi

          jq -c '.reviews[]' result.json | while read -r review; do
            file=$(echo "$review" | jq -r '.file')
            line=$(echo "$review" | jq -r '.line')
            comment=$(echo "$review" | jq -r '.comment')
            sha="${{ steps.get-sha.outputs.sha }}"

            echo "â¤ Posting comment on $file:$line"

            json=$(jq -n \
              --arg commit_id "$sha" \
              --arg path "$file" \
              --arg side "RIGHT" \
              --arg body "$comment" \
              --argjson line "$line" \
              '{body: $body, commit_id: $commit_id, path: $path, side: $side, line: $line}'
            )

            echo "ğŸ“¤ Request JSON:"
            echo "$json"

            response=$(curl -s -w "\nğŸŸ¢ HTTP %{http_code}\n" -X POST https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/comments \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$json")

            echo "ğŸ“¥ GitHub Response:"
            echo "$response"
          done

      - name: Check Run ì™„ë£Œ (success)
        if: ${{ success() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X PATCH https://api.github.com/repos/${{ github.repository }}/check-runs/${{ steps.create-check.outputs.check_id }} \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "status": "completed",
              "conclusion": "success",
              "completed_at": "'"$(date --utc +%Y-%m-%dT%H:%M:%SZ)"'",
              "output": {
                "title": "ì½”ë“œ ë¦¬ë·° ì™„ë£Œ",
                "summary": "ì½”ë“œ ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ëë‚¬ìŠµë‹ˆë‹¤."
              }
            }'

      - name: Check Run ì™„ë£Œ (failure)
        if: ${{ failure() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X PATCH https://api.github.com/repos/${{ github.repository }}/check-runs/${{ steps.create-check.outputs.check_id }} \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "status": "completed",
              "conclusion": "failure",
              "completed_at": "'"$(date --utc +%Y-%m-%dT%H:%M:%SZ)"'",
              "output": {
                "title": "ì½”ë“œ ë¦¬ë·° ì‹¤íŒ¨",
                "summary": "ì½”ë“œ ë¦¬ë·° ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              }
            }'
